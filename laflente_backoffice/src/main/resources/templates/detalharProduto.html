<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<meta name="description" content="" />
	<meta name="author" content="" />
	<title>LaFlente</title>
	<!-- loader-->
	<link href="../assets/css/pace.min.css" rel="stylesheet" />
	<script src="../assets/js/pace.min.js"></script>
	<!--favicon-->
	<link rel="icon" href="../assets/images/favicon.ico" type="image/x-icon">
	<!-- simplebar CSS-->
	<link href="../assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
	<!-- Bootstrap core CSS-->
	<link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
	<!-- animate CSS-->
	<link href="../assets/css/animate.css" rel="stylesheet" type="text/css" />
	<!-- Icons CSS-->
	<link href="../assets/css/icons.css" rel="stylesheet" type="text/css" />
	<!-- Sidebar CSS-->
	<link href="../assets/css/sidebar-menu.css" rel="stylesheet" />
	<!-- Custom Style-->
	<link href="../assets/css/app-style.css" rel="stylesheet" />


</head>

<body class="bg-theme bg-theme1">

	<!-- start loader -->
	<div id="pageloader-overlay" class="visible incoming">
		<div class="loader-wrapper-outer">
			<div class="loader-wrapper-inner">
				<div class="loader"></div>
			</div>
		</div>
	</div>
	<!-- end loader -->

	<!-- Start wrapper-->
	<div id="wrapper">

		<!--Start sidebar-wrapper-->
		<div id="sidebar-wrapper" data-simplebar="" data-simplebar-auto-hide="true">
			<div class="brand-logo">
				<a href="/">
					<h1>LaFlente</h1>
				</a>
			</div>
			<ul class="sidebar-menu do-nicescrol">
				<li class="sidebar-header">Menus</li>
				<li><a href="/"> <i class="zmdi zmdi-view-dashboard"></i> <span>Dashboard</span>
					</a></li>

				<li><a href="/cadastrarProduto"> <i class="zmdi zmdi-invert-colors"></i> <span>Cadastrar
							Produto</span>
					</a></li>


				<li><a href="/estoque"> <i class="zmdi zmdi-face"></i> <span>Estoque</span>
					</a></li>
				<li><a href="/cadastrarUsuario"> <i class="zmdi zmdi-account-circle"></i>
						<span>Cadastrar
							Usuário</span>
					</a></li>




				<li>
        <a href="/logout">
          <i class="zmdi zmdi-lock"></i> <span>Sair</span>
        </a>
      </li>
		</div>
		<!--End sidebar-wrapper-->


		<!--Start topbar header-->
		<header class="topbar-nav">
			<nav class="navbar navbar-expand fixed-top">
				<ul class="navbar-nav mr-auto align-items-center">
					<li class="nav-item"><a class="nav-link toggle-menu" href="javascript:void();"> <i
								class="icon-menu menu-icon"></i>
						</a></li>
					<li class="nav-item"></li>
				</ul>

				<a class="nav-link dropdown-toggle dropdown-toggle-nocaret" data-toggle="dropdown" href="#"> <span
						class="user-profile"><img src="https://via.placeholder.com/110x110" class="img-circle"
							alt="user avatar"></span>
				</a>
				<ul class="dropdown-menu dropdown-menu-right">
					<li class="dropdown-item user-details"><a href="javaScript:void();">
							<div class="media">
								<div class="avatar">
									<img class="align-self-start mr-3" src="https://via.placeholder.com/110x110"
										alt="user avatar">
								</div>
								<div class="media-body">
									<h6 class="mt-2 user-title">Sarajhon Mccoy</h6>
									<p class="user-subtitle">mccoy@example.com</p>
								</div>
							</div>
						</a></li>
					<li class="dropdown-divider"></li>
					<li class="dropdown-item"><i class="icon-envelope mr-2"></i>
						Inbox</li>
					<li class="dropdown-divider"></li>
					<li class="dropdown-item"><i class="icon-wallet mr-2"></i>
						Account</li>
					<li class="dropdown-divider"></li>
					<li class="dropdown-item"><i class="icon-settings mr-2"></i>
						Setting</li>
					<li class="dropdown-divider"></li>
					<li class="dropdown-item"><i class="icon-power mr-2"></i>
						Logout</li>
				</ul>
				</li>
				</ul>
			</nav>
		</header>
		<!--End topbar header-->
		<div class="clearfix"></div>

		<div class="content-wrapper">
			<div class="container-fluid">



				<div class="col-lg-6">
					<div class="card">
						<div class="card-body">
							<div class="card-title" align="center">Editar Produto</div>
							<h3 id="mensagem" align="center"></h3>
							<div class="mt-5" align="center" width="300" height="300">
								<div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
									<div class="carousel-inner" id="imagens">


									</div>
									<a class="carousel-control-prev" href="#carouselExampleControls" role="button"
										data-slide="prev">
										<span class="carousel-control-prev-icon" aria-hidden="true"></span>
										<span class="sr-only">Previous</span>
									</a>
									<a class="carousel-control-next" href="#carouselExampleControls" role="button"
										data-slide="next">
										<span class="carousel-control-next-icon" aria-hidden="true"></span>
										<span class="sr-only">Next</span>
									</a>
								</div>
							</div>

							<hr>
							<form>
								<table>
									<tbody id="listaImagens">
									</tbody>
								</table>

								<div class="form-group">
									<label for="inputNome">Nome</label> <input type="text"
										class="form-control form-control-rounded" id="inputNome"
										placeholder="Digite o nome do produto">
								</div>
								<div class="form-group">
									<label for="inputPreco">Preço</label> <input type="text"
										class="form-control form-control-rounded" id="inputPreco"
										placeholder="Digite o preço do produto">
								</div>
								<div class="form-group">
									<label for="inputQuantidade">Quantidade</label> <input type="text"
										class="form-control form-control-rounded" id="inputQuantidade"
										placeholder="Digite a quantidade do produto">
								</div>
								<div class="form-group ">
									<label for="inputPalavraChave">Palavra Chave</label>
									<div class="form-group form-inline">
										<input type="text" class="form-control form-control-rounded"
											id="inputPalavraChave" placeholder="Palavra Chave">
										<button type="submit" class="btn btn-light btn-round ml-3"
											onclick="adicionarPalavraChave()">
											<i class=""> Adicionar</i>
										</button>
									</div>
									<table>
									<tbody id="palavrasChaves">
									</tbody>
									</table>
								</div>
								<div class="form-group">
									<label for="inputDescricaoCurta">Descrição Curta</label> <input type="text"
										class="form-control form-control-rounded" id="inputDescricaoCurta"
										placeholder="Descrição Curta">
								</div>
								<label for="inputDescricaoDetalhada">Descrição Detalhada</label>
								<textarea class="form-control" id="inputDescricaoDetalhada" rows="5">
										 </textarea>
								<div class="form-group">
									<div class="form-group">
									<label for="inputPergunta">Pergunta</label><input type="text" class="form-control form-control-rounded" id="inputPergunta"
									placeholder="Digite a pergunta">
									<label for="inputResposta">Resposta</label><input type="text" class="form-control form-control-rounded" id="inputResposta"
									placeholder="Digite a resposta">
									<button style="margin-top: 15px" type="button" onClick="adicionarPerguntaResposta()"
									class="btn btn-light btn-round px-5">
										<i></i> Adicionar
									</button>
									</div>
									<ul id="perguntasRespostas"></ul>
								</div>
								
								<div class="form-group py-2">
									<label for="inputImagem">Selecionar imagens</label><br>
									<input id="inputImagem" type="file" multiple="multiple"
										required="true" />
								</div>
								
								<div class="form-group" align="center">
									<button type="button" onclick="atualizarProduto()"
										class="btn btn-light btn-round px-5" id="salvar">
										<i class=""></i> Salvar Alterações
									</button>
								</div>

							</form>
						</div>
					</div>
				</div>
			</div>
		</div>


		<!--start overlay-->
		<div class="overlay toggle-menu"></div>
		<!--end overlay-->

	</div>
	<!-- End container-fluid-->

	</div>
	<!--End content-wrapper-->
	<!--Start Back To Top Button-->
	<a href="javaScript:void();" class="back-to-top"><i class="fa fa-angle-double-up"></i> </a>
	<!--End Back To Top Button-->

	<!--Start footer-->

	<!--End footer-->


	<!--start color switcher-->
	<div class="right-sidebar">
		<div class="switcher-icon">
			<i class="zmdi zmdi-settings zmdi-hc-spin"></i>
		</div>
		<div class="right-sidebar-content">

			<p class="mb-0">Gaussion Texture</p>
			<hr>

			<ul class="switcher">
				<li id="theme1"></li>
				<li id="theme2"></li>
				<li id="theme3"></li>
				<li id="theme4"></li>
				<li id="theme5"></li>
				<li id="theme6"></li>
			</ul>

			<p class="mb-0">Gradient Background</p>
			<hr>

			<ul class="switcher">
				<li id="theme7"></li>
				<li id="theme8"></li>
				<li id="theme9"></li>
				<li id="theme10"></li>
				<li id="theme11"></li>
				<li id="theme12"></li>
				<li id="theme13"></li>
				<li id="theme14"></li>
				<li id="theme15"></li>
			</ul>

		</div>
	</div>
	<!--end color switcher-->

	</div>
	<!--End wrapper-->


	<!-- Bootstrap core JavaScript-->
	<script src="../assets/js/jquery.min.js"></script>
	<script src="../assets/js/popper.min.js"></script>
	<script src="../assets/js/bootstrap.min.js"></script>

	<!-- simplebar js -->
	<script src="../assets/plugins/simplebar/js/simplebar.js"></script>
	<!-- sidebar-menu js -->
	<script src="../assets/js/sidebar-menu.js"></script>

	<!-- Custom scripts -->
	<script src="../assets/js/app-script.js"></script>

	<script>
		var palavras = [];
		var arrayPerguntasRespostas = [];
		var arrayImagens = [];
		var imagensRemovidas = [];
		var palavrasRemovidas = [];
		var perguntasRespostasRemovidas = [];

		let url = window.location.href.split('/');
		let codigo = url[4];

		console.log(codigo)

		get("http://localhost:8080/produto/" + codigo).then(produto => {
			preencherCampos(produto);
		})


		let tema = localStorage.getItem("tema");

		if (tema) {
			document.querySelector("body").className = tema;
		} else {

			document.querySelector("body").className = "bg-theme bg-theme1";
		}
		
		function adicionarPalavraChave() {
			event.preventDefault();
			let input = document.getElementById("inputPalavraChave");

			let palavra = { palavraChave: input.value };

			let listaPalavras = document.getElementById("palavrasChaves");

			palavras.push(palavra);

			listaPalavras.innerHTML = "";

			palavras.forEach(palavraChave => {
				listaPalavras.insertAdjacentHTML('beforeend', `
						<tr>
						<td>
						<li>${palavraChave.palavraChave}</li>
						</td>
						<td>
						<button class="btn btn-light btn-round px-3 ml-3" type="button" onclick="removerPalavraChaveLista('${palavraChave.id}')" id="${palavraChave.id}"> Remover</button>
						</td>
						<br>
					</tr>`);
				
			});

			input.value = "";
		}
		
		function adicionarPerguntaResposta() {
			event.preventDefault();
			let inputPergunta = document.getElementById("inputPergunta");
			let inputResposta = document.getElementById("inputResposta");
			
			let perguntasRespostas = {
				pergunta: inputPergunta.value,
				resposta: inputResposta.value
			}
			
			let listaPerguntasRespostas = document.getElementById("perguntasRespostas");

			arrayPerguntasRespostas.push(perguntasRespostas);

			listaPerguntasRespostas.innerHTML = "";

			arrayPerguntasRespostas.forEach(perguntaResposta => {
				listaPerguntasRespostas.insertAdjacentHTML('beforeend', `
						<li>${perguntaResposta.pergunta}</li>
						<ul><li>${perguntaResposta.resposta}</li></ul>
						<button class="btn btn-light btn-round px-3 ml-3" type="button" onclick="removerPerguntaRespostaLista('${perguntaResposta.id}')" id="${perguntaResposta.id}"> Remover</button>
						`);
			});

			inputPergunta.value = "";
			inputResposta.value = "";
			
			
		}


		function get(url) {
			return new Promise((resolve, reject) => {

				let xhr = new XMLHttpRequest();

				xhr.open('GET', url);

				xhr.onreadystatechange = () => {

					if (xhr.readyState == 4) {

						if (xhr.status == 200) {

							resolve(JSON.parse(xhr.responseText));

						} else {

							reject(xhr.responseText);
						}
					}
				}

				xhr.send();
			});
		}

		function preencherCampos(produto) {
			let inputNome = document.getElementById("inputNome");
			let inputPreco = document.getElementById("inputPreco");
			let inputQuantidade = document.getElementById("inputQuantidade");
			let inputPalavraChave = document.getElementById("inputPalavraChave");
			let inputDescricaoCurta = document.getElementById("inputDescricaoCurta");
			let inputDescricaoDetalhada = document.getElementById("inputDescricaoDetalhada");
			let inputPergunta = document.getElementById("inputPergunta");
			let inputResposta = document.getElementById("inputResposta");
			let btnAdicionar = document.getElementById("adicionar");
			let btnSalvar = document.getElementById("salvar");

			palavras = produto.palavraChave;
			arrayPerguntasRespostas = produto.perguntaResposta;

			inputNome.value = produto.nome;
			inputPreco.value = produto.preco;
			inputQuantidade.value = produto.quantidade;
			inputDescricaoCurta.value = produto.descricaoCurta;
			inputDescricaoDetalhada.value = produto.descricaoDetalhada;

			renderizarImagens(produto.imagem);
			listarImagens(produto.imagem);
			preencherPalavrasChaves(produto.palavraChave);
			preencherPerguntasRespostas(produto.perguntaResposta);
			
			arrayImagens = produto.imagem;
			palavras = produto.palavraChave;

		}

		function preencherPalavrasChaves(palavrasChaves) {

			let listaPalavras = document.getElementById("palavrasChaves");


			listaPalavras.innerHTML = "";

			palavrasChaves.forEach(palavraChave => {
				listaPalavras.insertAdjacentHTML('beforeend', `
						
						<tr>
						<td>
						<li>${palavraChave.palavraChave}</li>
						</td>
						<td>
						<button class="btn btn-light btn-round px-3 ml-3" type="button" onclick="removerPalavraChaveLista('${palavraChave.id}')" id="${palavraChave.id}"> Remover</button>
						</td>
						<br>
					</tr>
						`);
			});

		}

		function preencherPerguntasRespostas(perguntasResposta) {

			let listaPerguntasRespostas = document.getElementById("perguntasRespostas");


			listaPerguntasRespostas.innerHTML = "";

			perguntasResposta.forEach(perguntaResposta => {
				listaPerguntasRespostas.insertAdjacentHTML('beforeend', `
						<li>${perguntaResposta.pergunta}</li>
						<ul>
						<li>${perguntaResposta.resposta}</li>
						</ul>
						<button class="btn btn-light btn-round px-3 ml-3" type="button" onclick="removerPerguntaRespostaLista('${perguntaResposta.id}')" id="${perguntaResposta.id}"> Remover</button>
						`);
			});

		}



		function atualizarProduto() {

			let inputNome = document.getElementById("inputNome");
			let inputPreco = document.getElementById("inputPreco");
			let inputQuantidade = document.getElementById("inputQuantidade");
			let palavrasChaves = palavras;
			let inputDescricaoCurta = document.getElementById("inputDescricaoCurta");
			let inputDescricaoDetalhada = document.getElementById("inputDescricaoDetalhada");
			let perguntas = arrayPerguntasRespostas.pergunta;
			let respostas = arrayPerguntasRespostas.resposta;


			let produto = {
				codigo: parseInt(codigo),
				nome: inputNome.value,
				preco: inputPreco.value,
				quantidade: inputQuantidade.value,
				//palavraChave: palavras,
				descricaoCurta: inputDescricaoCurta.value,
				descricaoDetalhada: inputDescricaoDetalhada.value,
				perguntaResposta: arrayPerguntasRespostas
			};


			removerImagens().then(() => {
				removerPalavraChave().then(() => {
					addPalavraBanco().then(() => {
						removerPerguntaResposta().then(() => {
							addPerguntaRespostaBanco().then(() => {
						
				put("http://localhost:8080/produto/" + produto.codigo, produto).then(() => {
					putImagem("http://localhost:8080/produto/imagem/"+produto.codigo+"-"+produto.nome, produto).then(() => {
						get("http://localhost:8080/produto/" + codigo).then(produto => {
							preencherCampos(produto);
						})
						document.getElementById("mensagem").textContent = "Produto editado com sucesso!!!";
					});
				});
				
				});
				});
				});
				});
			});
			
		}
		
		function removerImagens(){
			return new Promise((resolve, reject) => {
				let promises = [];
				for(let i = 0; i < imagensRemovidas.length; i++){
					promises.push(new Promise((resolve, reject) => {
						remove(`http://localhost:8080/produto/${imagensRemovidas[i]}`).then(() => resolve())
					}));
				}
				
				Promise.all(promises).then(() => resolve());
			});
		}
		
		function removerPalavraChave(){
			return new Promise((resolve, reject) => {
				let promises = [];
				for(let i = 0; i < palavrasRemovidas.length; i++){
					promises.push(new Promise((resolve, reject) => {
						remove(`http://localhost:8080/produto/palavrasChave/${palavrasRemovidas[i]}`).then(() => resolve())
					}));
				}
				
				Promise.all(promises).then(() => resolve());
			});
		}
		
		function addPalavraBanco(){
			return new Promise((resolve, reject) => {
				let promises = [];
				for(let i = 0; i < palavras.length; i++){
					promises.push(new Promise((resolve, reject) => {
						console.log(palavras[i])
						post(`http://localhost:8080/produto/palavrasChave/${codigo}`,palavras[i]).then(() => resolve())
					}));
				}
				
				Promise.all(promises).then(() => resolve());
			});
		}
		
		function removerPerguntaResposta(){
			return new Promise((resolve, reject) => {
				let promises = [];
				for(let i = 0; i < perguntasRespostasRemovidas.length; i++){
					promises.push(new Promise((resolve, reject) => {
						remove(`http://localhost:8080/produto/perguntasRespostas/${perguntasRespostasRemovidas[i]}`).then(() => resolve())
					}));
				}
				
				Promise.all(promises).then(() => resolve());
			});
		}
		
		function addPerguntaRespostaBanco(){
			return new Promise((resolve, reject) => {
				let promises = [];
				for(let i = 0; i < arrayPerguntasRespostas.length; i++){
					promises.push(new Promise((resolve, reject) => {
						console.log(arrayPerguntasRespostas[i])
						post(`http://localhost:8080/produto/perguntasRespostas/${codigo}`,arrayPerguntasRespostas[i]).then(() => resolve())
					}));
				}
				
				Promise.all(promises).then(() => resolve());
			});
		}
		
		function post(url, dados) {
			return new Promise((resolve, reject) => {

				let xhr = new XMLHttpRequest();
				xhr.open("POST", url, true);
				xhr.setRequestHeader("Content-type", "application/json");
				xhr.onreadystatechange = () => {

					if (xhr.readyState == 4) {

						if (xhr.status == 201) {
							resolve();
						} else {
							reject(xhr.responseText);
						}
					}
				};
				
				xhr.send(JSON.stringify(dados));
			});
		}

		function put(url, dados) {
			return new Promise((resolve, reject) => {

				let xhr = new XMLHttpRequest();
				xhr.open("PUT", url, true);
				xhr.setRequestHeader("Content-type", "application/json");
				xhr.onreadystatechange = () => {

					if (xhr.readyState == 4) {

						if (xhr.status == 200) {
							resolve();
						} else {
							reject(xhr.responseText);
						}
					}
				};

				xhr.send(JSON.stringify(dados));
			});
		}
		
		function remove(url) {
			return new Promise((resolve, reject) => {

				let xhr = new XMLHttpRequest();
				xhr.open("DELETE", url, true);
				xhr.setRequestHeader("Content-type", "application/json");
				xhr.onreadystatechange = () => {

					if (xhr.readyState == 4) {

						if (xhr.status == 200) {
							resolve();
						} else {
							reject(xhr.responseText);
						}
					}
				};

				xhr.send();
			});
		}


		function renderizarImagens(imagens) {
			let imgDiv = document.getElementById("imagens");
			
			imgDiv.innerHTML = "";
			for (let i = 0; i < imagens.length; i++) {
				let active = "";
				if (i == 0) {
					active = "active";
				}
				imgDiv.insertAdjacentHTML('beforeend', `
						<div class="carousel-item ${active}" width="300" height="300">
					     <img class="d-block w-40" src="data:image/${imagens[i].extensao};base64,${imagens[i].imagem}" width="300" height="300">
					   </div>`);

			}
		}

		function listarImagens(imagens) {
			let imgDiv = document.getElementById("listaImagens");
			imgDiv.innerHTML = "";

			for (let i = 0; i < imagens.length; i++) {
				let active = "";
				if (i == 0) {
					active = "active";
				}
				imgDiv.insertAdjacentHTML('beforeend', `
				<tr>
					<td>
					<img class="d-block w-40" src="data:image/${imagens[i].extensao};base64,${imagens[i].imagem}" width="30" height="30">
					</td>
					<td>
						<button class="btn btn-light btn-round px-3 ml-3" type="button" onclick="removerImagemLista('${imagens[i].id}')" id="${imagens[i].id}"> Remover</button>
					</td>
					<br>
				</tr>
					    
					     `);

			}
		}
		
		function removerImagemLista(id){
			event.preventDefault();
			for(let i = 0; i < arrayImagens.length; i++){
				if(arrayImagens[i].id == id){
					let removido = arrayImagens.splice(i, 1);

					imagensRemovidas.push(id);
					listarImagens(arrayImagens);
					renderizarImagens(arrayImagens);
					return;
				}
			}
			
			 
		}
		
		function removerPalavraChaveLista(id){
			event.preventDefault();
			for(let i = 0; i < palavras.length; i++){
				if(palavras[i].id == id){
					let removido = palavras.splice(i, 1);

					palavrasRemovidas.push(id);
					preencherPalavrasChaves(palavras);
					return;
				}
			} 
		}
		
		function removerPerguntaRespostaLista(id){
			event.preventDefault();
			for(let i = 0; i < arrayPerguntasRespostas.length; i++){
				if(arrayPerguntasRespostas[i].id == id){
					let removido = arrayPerguntasRespostas.splice(i, 1);

					perguntasRespostasRemovidas.push(id);
					preencherPerguntasRespostas(arrayPerguntasRespostas);
					return;
				}
			} 
		}
		
		function putImagem(url, produto){
			return new Promise((resolve, reject) => {
				let inputImagem = document.getElementById("inputImagem");

				let files = inputImagem.files;
				
				let promises = [];
				for(let i = 0; i < files.length; i++){
					promises.push(new Promise((resolve, reject) => {
						let formData = new FormData();
						formData.append("imagem", files[i]);
						
						let fileName = files[i].name.split(".");
						
						let extensao = fileName[fileName.length - 1];
						let xhr = new XMLHttpRequest();
						xhr.open("PUT", url + "-" + i + "-" + extensao, true);
						
						xhr.onreadystatechange = () => {

							if (xhr.readyState == 4) {

								if (xhr.status == 200) {

									resolve();
								} else {
									reject(xhr.responseText);
								}
							}
						};
						
						xhr.send(formData);	
					}));
				}
				
				Promise.all(promises).then(() => resolve());
					
			});
		}
	</script>
</body>

</html>